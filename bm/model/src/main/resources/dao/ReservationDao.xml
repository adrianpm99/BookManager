<?xml version="1.0" encoding="UTF-8"?>
<JdbcEntitySetup
 xmlns="http://www.ontimize.com/schema/jdbc"
 xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
 xsi:schemaLocation="http://www.ontimize.com/schema/jdbc http://www.ontimize.com/schema/jdbc/ontimize-jdbc-dao.xsd"
 catalog="" schema="${mainschema}" table="RESERVATION"
 datasource="mainDataSource" sqlhandler="dbSQLStatementHandler">
 <DeleteKeys>
  <Column>RESERVATIONID</Column>
 </DeleteKeys>
 <UpdateKeys>
  <Column>reservationid</Column>
 </UpdateKeys>
 <GeneratedKey>reservationid</GeneratedKey>
 
 <Queries>
  <Query id="details">
  <AmbiguousColumns>
	  <AmbiguousColumn name="B_BOOKID" prefix="B"
	     databaseName="BOOKID" />
	   <AmbiguousColumn name="R_BOOKID" prefix="R"
	   databaseName="BOOKID" />
	   <AmbiguousColumn name="C_CUSTOMERID" prefix="C"
	     databaseName="CUSTOMERID" />
	   <AmbiguousColumn name="R_CUSTOMERID" prefix="R"
	   databaseName="CUSTOMERID" />
   </AmbiguousColumns>
   <Sentence>
   <![CDATA[
     SELECT
      #COLUMNS#
     FROM
      RESERVATION R
     INNER JOIN BOOK B ON
      R.BOOKID = B.BOOKID
     INNER JOIN CUSTOMER C ON
      R.CUSTOMERID = C.CUSTOMERID
     #WHERE#
   ]]>
   </Sentence>
  </Query>
  <Query id="check_avaliable_book_copies">
  	<AmbiguousColumns>
	  	<AmbiguousColumn name="CL_COPYID" prefix="CL" databaseName="COPYID" />
	  	<AmbiguousColumn name="COPYID" prefix="C" databaseName="COPYID" />
	  	<AmbiguousColumn name="CL_LENDINGID" prefix="CL" databaseName="LENDINGID" />
	   	<AmbiguousColumn name="LENDINGID" prefix="L" databaseName="LENDINGID" />
  	</AmbiguousColumns>
  	<Sentence>
  	<![CDATA[
  		SELECT #COLUMNS#
  		FROM COPY C
  		INNER JOIN COPYLENDING CL ON CL.COPYID= C.COPYID
  		INNER JOIN LENDING L ON L.LENDINGID = CL.LENDINGID
  		#WHERE#
		AND LENDINGRETURNDATE NOTNULL
  	]]>
  	</Sentence>
  </Query>
  <Query id="reservationsAvailable">
  	<AmbiguousColumns>
  	  <AmbiguousColumn name="BOOKID" prefix="B" databaseName="BOOKID" />
	  <AmbiguousColumn name="COP_BOOKID" prefix="COP" databaseName="BOOKID" />
	  <AmbiguousColumn name="COPYID" prefix="COP" databaseName="COPYID" />
	   <AmbiguousColumn name="CL_COPYID" prefix="R" databaseName="COPYID" />
	   <AmbiguousColumn name="LENDINGID" prefix="L" databaseName="LENDINGID" />
	   <AmbiguousColumn name="CL_LENDINGID" prefix="CL" databaseName="LENDINGID" />
  	</AmbiguousColumns>
 	<Sentence>
 	 <![CDATA[
    SELECT
		#COLUMNS#
	FROM
		COPY COP
	INNER JOIN COPYLENDING CL ON
		COP.COPYID = CL.COPYID
	INNER JOIN LENDING L ON
		CL.LENDINGID = L.LENDINGID
	INNER JOIN BOOK B ON
		COP.BOOKID = B.BOOKID
	WHERE
		L.LENDINGRETURNDATE IS NULL 	
	EXCEPT 
	SELECT
		#COLUMNS#
	FROM
		COPY COP
	INNER JOIN COPYLENDING CL ON
		COP.COPYID = CL.COPYID
	INNER JOIN LENDING L ON
		CL.LENDINGID = L.LENDINGID
	INNER JOIN BOOK B ON
		COP.BOOKID = B.BOOKID
	WHERE
		L.LENDINGRETURNDATE IS NOT NULL
   ]]>
 	</Sentence>
 </Query>
 <Query id="expiredReservation">
 <AmbiguousColumns>
	  <AmbiguousColumn name="B_BOOKID" prefix="B"
	     databaseName="BOOKID" />
	   <AmbiguousColumn name="R_BOOKID" prefix="R"
	   databaseName="BOOKID" />
	   <AmbiguousColumn name="CUSTOMERID" prefix="C"
	     databaseName="CUSTOMERID" />
	   <AmbiguousColumn name="R_CUSTOMERID" prefix="R"
	   databaseName="CUSTOMERID" />
   </AmbiguousColumns>
   <Sentence>
   <![CDATA[
     SELECT
      #COLUMNS#
     FROM
      RESERVATION R
     INNER JOIN BOOK B ON
      R.BOOKID = B.BOOKID
     INNER JOIN CUSTOMER C ON
      R.CUSTOMERID = C.CUSTOMERID
     WHERE RESERVATIONDEADLINE < CURRENT_DATE 
   ]]>
   </Sentence>
 </Query>
 
 <Query id="reservationCopyShelving">
 <AmbiguousColumns>
 <AmbiguousColumn name="COPYID" prefix="R"
	     databaseName="COPYID" />
	   <AmbiguousColumn name="CS_COPYID" prefix="CS"
	   databaseName="COPYID" />
 </AmbiguousColumns>
 <Sentence>
   <![CDATA[
     SELECT
      #COLUMNS#
     FROM
      RESERVATION R
     INNER JOIN COPYSHELVING CS ON
      CS.COPYID = R.COPYID
     #WHERE#
   ]]>
   </Sentence>
 </Query>
 
 <Query id="reservationCurrent">
 <AmbiguousColumns>
	  <AmbiguousColumn name="BOOKID" prefix="R"
		     databaseName="BOOKID" />
	   <AmbiguousColumn name="C_BOOKID" prefix="C"
		  	 databaseName="BOOKID" />
	   <AmbiguousColumn name="B_BOOKID" prefix="B"
			  databaseName="BOOKID" />
	   <AmbiguousColumn name="COPYID" prefix="C"
		     databaseName="COPYID" />
	   <AmbiguousColumn name="R_COPYID" prefix="R"
		     databaseName="COPYID" />
	   <AmbiguousColumn name="CL_COPYID" prefix="CL"
		     databaseName="COPYID" />
	   <AmbiguousColumn name="LENDINGID" prefix="L"
	  		 databaseName="LENDINGID" />
	   <AmbiguousColumn name="CL_LENDINGID" prefix="CL"
	 		  databaseName="LENDINGID" />
	   <AmbiguousColumn name="CUSTOMERID" prefix="R"
	 		  databaseName="CUSTOMERID" />
	   <AmbiguousColumn name="CU_CUSTOMERID" prefix="CU"
			  databaseName="CUSTOMERID" />
	   <AmbiguousColumn name="L_CUSTOMERID" prefix="L"
			   databaseName="CUSTOMERID" />
		
   </AmbiguousColumns>
   <Sentence>
   <![CDATA[
 	SELECT
      distinct (R.bookid) as IDBOOK,  
      C.COPYID,C.COPYCODE,B.BOOKTITLE,B.BOOKID,
       (select min(R.reservationid) as ID from reservation r where r.bookid= b.bookid and R.COPYID IS null ) as RESERVATIONID,
       (select CUS.CUSTOMERNAME from CUSTOMER CUS, RESERVATION RES
       		where CUS.CUSTOMERID = RES.CUSTOMERID and RES.RESERVATIONID = 
       			(select min(R.reservationid)  from reservation r where r.bookid= b.bookid and R.COPYID IS null )) as CUSTOMERNAME,
       (select CUS.CUSTOMERSURNAME from CUSTOMER CUS, RESERVATION RES
       		where CUS.CUSTOMERID = RES.CUSTOMERID and RES.RESERVATIONID = 
       			(select min(R.reservationid)  from reservation r where r.bookid= b.bookid and R.COPYID IS null )) as CUSTOMERSURNAME 
     FROM
     RESERVATION R
     	INNER JOIN COPY C ON
     	  R.BOOKID = C.BOOKID 
     	INNER JOIN BOOK B ON
     	  B.BOOKID = C.BOOKID
     	INNER JOIN CUSTOMER CU ON
     	  CU.CUSTOMERID = R.CUSTOMERID	
      	INNER JOIN COPYLENDING CL ON
      		C.COPYID = CL.COPYID
      	INNER JOIN LENDING L ON
       		CL.LENDINGID = L.LENDINGID
       #WHERE#
        AND R.COPYID IS NULL
        GROUP BY R.BOOKID,C.COPYID,C.COPYCODE,B.BOOKTITLE,B.BOOKID
        ORDER BY RESERVATIONID

    ]]>
   </Sentence>
 </Query>
 <Query id="customerPendingReservations">
 <AmbiguousColumns>
 <AmbiguousColumn name="BOOKID" prefix="B" databaseName="BOOKID" />
 <AmbiguousColumn name="CUSTOMERID" prefix="C" databaseName="CUSTOMERID"/>
 </AmbiguousColumns>
 <Sentence>
   <![CDATA[
 	SELECT
 	 #COLUMNS#
 	FROM
 	 RESERVATION R
 	INNER JOIN BOOK B ON
 	 B.BOOKID = R.BOOKID
 	 INNER JOIN CUSTOMER C ON
 	 C.CUSTOMERID = R.CUSTOMERID
 	#WHERE#		
 		]]>
 	</Sentence>
 </Query>
 </Queries>
</JdbcEntitySetup>